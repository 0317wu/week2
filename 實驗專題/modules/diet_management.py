from linebot.models import FlexSendMessage, TextSendMessage
import random
import sqlite3

user_states = {}


def get_db_connection(database):
    conn = sqlite3.connect(database)
    conn.row_factory = sqlite3.Row
    return conn

def calculate_bmi(weight, height_cm):
    height_m = height_cm / 100
    bmi = weight / (height_m ** 2)
    return bmi

def recommend_daily_menu(bmi):
    menus = {
        "underweight": {
            "breakfast": [
                "香蕉牛奶燕麥片 + 水煮蛋 + 香蕉",
                "全麥吐司 + 花生醬 + 牛奶",
                "豆漿 + 蔬菜三明治",
                "水果沙拉 + 燕麥餅乾",
                "雞蛋蔬菜煎餅 + 豆漿",
                "藍莓優格杯 + 堅果",
                "牛奶煎餅 + 蜂蜜",
                "水果奶昔 + 全麥麵包",
                "綜合堅果 + 水果",
                "素食漢堡 + 蔬菜汁",
                "烤地瓜 + 酸奶",
                "菠菜芝士歐姆蛋 + 全麥吐司",
                "鳳梨糙米粥 + 水果",
                "豆腐蔬菜湯 + 全麥饅頭",
                "蜂蜜核桃麥片 + 牛奶",
                "番茄炒蛋 + 全麥吐司",
                "水果優格沙拉 + 燕麥餅乾",
                "牛油果吐司 + 水煮蛋",
                "香菇豆腐粥 + 水果",
                "玉米片 + 低脂牛奶 + 水果"
            ],
            "lunch": [
                "雞胸肉炒飯 + 水煮青菜 + 雞湯",
                "牛肉麵 + 青菜 + 豆腐",
                "三文魚便當 + 蔬菜沙拉",
                "雞肉蔬菜捲 + 糙米飯",
                "豬里脊炒蔬菜 + 米飯",
                "蝦仁炒麵 + 青菜湯",
                "烤鴨腿 + 地瓜 + 蔬菜",
                "素食披薩 + 混合沙拉",
                "牛肉壽喜燒 + 白飯",
                "鯖魚定食 + 味噌湯",
                "火雞肉三明治 + 蔬菜湯",
                "蒜蓉蒸蝦 + 糙米飯 + 青菜",
                "豆腐蔬菜燴飯 + 湯",
                "羊肉串 + 烤蔬菜 + 全麥麵包",
                "泰式炒河粉 + 涼拌木瓜",
                "豬腳飯 + 蔬菜",
                "素食壽司 + 味噌湯",
                "牛肉炒西蘭花 + 米飯",
                "雞肉咖哩 + 藜麥",
                "鯛魚燉豆腐 + 紫米飯"
            ],
            "dinner": [
                "義大利麵 + 魚排 + 番茄濃湯",
                "烤雞腿 + 馬鈴薯泥 + 蔬菜沙拉",
                "牛肉燉蔬菜 + 全麥麵包",
                "豆腐炒青菜 + 紫米飯",
                "泰式炒河粉 + 涼拌青木瓜",
                "燉羊肉 + 蔬菜 + 全麥飯",
                "海鮮燴飯 + 蔬菜湯",
                "素食咖哩 + 藜麥",
                "蒸豆魚 + 青菜 + 糙米飯",
                "烤蔬菜拼盤 + 雞肉串",
                "烤鮭魚 + 蔬菜沙拉",
                "瘦牛肉炒西蘭花 + 藜麥",
                "番茄豆腐湯 + 全麥吐司",
                "燉雞肉 + 藜麥沙拉",
                "素食焗飯 + 混合蔬菜",
                "烤羊排 + 地瓜泥 + 青菜",
                "蒸鱈魚 + 蔬菜 + 紫米飯",
                "蔬菜豆腐鍋 + 全麥飯",
                "牛肉燉蘑菇 + 全麥麵包",
                "烤鴨腿 + 地瓜泥 + 蔬菜"
            ],
            "snack": [
               "花生醬吐司 + 杏仁牛奶",
                "優格 + 堅果",
                "水果優格冰沙",
                "蔬菜棒配鷹嘴豆泥",
                "全麥餅乾 + 水果",
                "香蕉奶昔",
                "低脂起司片 + 蘋果",
                "能量棒",
                "堅果混合",
                "胡蘿蔔條 + 低脂酸奶",
                "水果乾 + 無糖優格",
                "藍莓奶昔",
                "燕麥能量球",
                "蔬菜沙拉 + 鷹嘴豆",
                "小份量低脂冰淇淋",
                "番茄片 + 低脂起司",
                "低糖果凍",
                "椰子水 + 堅果",
                "低脂奶酪 + 水果片",
                "葡萄乾 + 無糖豆奶"
            ]
        
        },
        "normal": {
            "breakfast": [
                "全麥吐司 + 蔬菜沙拉 + 水煮蛋",
                "燕麥片 + 藍莓 + 牛奶",
                "水果優格碗 + 燕麥",
                "蔬菜蛋白奶昔",
                "雞蛋蔬菜煎餅 + 果汁",
                "綜合水果盤 + 堅果",
                "低脂牛奶 + 全麥麵包",
                "豆漿 + 燕麥粥",
                "水果沙拉 + 燕麥餅",
                "素食漢堡 + 蔬菜汁",
                "牛油果吐司 + 水煮蛋",
                "菠菜芝士歐姆蛋 + 全麥吐司",
                "鳳梨糙米粥 + 水果",
                "豆腐蔬菜湯 + 全麥饅頭",
                "蜂蜜核桃麥片 + 牛奶",
                "番茄炒蛋 + 全麥吐司",
                "水果優格沙拉 + 燕麥餅乾",
                "香菇豆腐粥 + 水果",
                "玉米片 + 低脂牛奶 + 水果",
                "牛奶煎餅 + 蜂蜜"
            ],
            "lunch": [
                  "燒烤雞胸肉 + 糙米飯 + 烤蔬菜",
                "蒸魚 + 地瓜 + 時令蔬菜湯",
                "雞肉凱薩沙拉 + 全麥麵包",
                "牛肉蔬菜炒麵 + 湯",
                "豆腐炒飯 + 青菜",
                "鮮蝦沙拉 + 全麥吐司",
                "火雞三明治 + 蔬菜湯",
                "素食壽司 + 味噌湯",
                "牛肉燉飯 + 青豆",
                "烤鴨肉 + 紫薯 + 蔬菜",
                "番茄牛肉燉飯 + 蔬菜",
                "烤雞肉捲 + 混合沙拉",
                "蔬菜炒麵 + 海鮮湯",
                "豆腐海鮮燴飯 + 湯",
                "羊肉炒蔬菜 + 全麥飯",
                "泰式牛肉沙拉 + 藜麥",
                "香煎鯖魚 + 糙米飯 + 青菜",
                "素食披薩 + 混合沙拉",
                "雞肉菠菜義大利麵 + 蔬菜湯",
                "鯛魚定食 + 味噌湯"
            ],
            "dinner": [
                "蒸魚 + 地瓜 + 時令蔬菜湯",
                "烤雞胸肉 + 蔬菜沙拉 + 糙米飯",
                "蔬菜豆腐鍋 + 全麥飯",
                "瘦肉燉菜 + 藜麥",
                "泰式綠咖哩 + 藜麥",
                "烤鮭魚 + 蔬菜拼盤",
                "素食披薩 + 混合沙拉",
                "牛肉燉蘑菇 + 全麥麵包",
                "烤鴨腿 + 地瓜泥",
                "豆腐煲 + 藜麥飯",
                "番茄牛肉燉飯 + 蔬菜",
                "香煎鯖魚 + 藜麥沙拉",
                "雞肉菠菜義大利麵 + 蔬菜湯",
                "素食咖哩 + 全麥飯",
                "烤羊排 + 地瓜泥 + 青菜",
                "蒸鱈魚 + 蔬菜 + 紫米飯",
                "豆腐蔬菜燴飯 + 藜麥",
                "牛肉炒西蘭花 + 藜麥",
                "燉雞肉 + 藜麥沙拉",
                "蔬菜焗飯 + 混合蔬菜"
            ],
            "snack": [
                "優格 + 堅果",
                "水果沙拉 + 低脂優格",
                "蔬菜棒配鷹嘴豆泥",
                "全麥餅乾 + 水果",
                "低脂起司 + 蘋果片",
                "胡蘿蔔條 + 低脂酸奶",
                "香蕉奶昔",
                "能量棒",
                "堅果混合",
                "水果優格冰沙",
                "藍莓奶昔",
                "燕麥能量球",
                "蔬菜沙拉 + 鷹嘴豆",
                "小份量低脂冰淇淋",
                "番茄片 + 低脂起司",
                "低糖果凍",
                "椰子水 + 堅果",
                "低脂奶酪 + 水果片",
                "葡萄乾 + 無糖優格",
                "水果乾 + 無糖豆奶"
            ]
        
        },
        "overweight": {
            "早餐": [
                "低脂優格 + 蘋果片 + 水煮蛋",
                "全麥吐司 + 牛油果 + 水煮蛋",
                "蔬菜燕麥粥 + 堅果",
                "水果奶昔 + 全麥餅乾",
                "雞蛋蔬菜煎餅 + 豆漿",
                "藍莓優格杯 + 堅果",
                "牛奶煎餅 + 蜂蜜",
                "水果沙拉 + 燕麥餅",
                "素食漢堡 + 蔬菜汁",
                "綜合堅果 + 水果",
                "菠菜芝士歐姆蛋 + 全麥吐司",
                "鳳梨糙米粥 + 水果",
                "豆腐蔬菜湯 + 全麥饅頭",
                "蜂蜜核桃麥片 + 牛奶",
                "番茄炒蛋 + 全麥吐司",
                "水果優格沙拉 + 燕麥餅乾",
                "香菇豆腐粥 + 水果",
                "玉米片 + 低脂牛奶 + 水果",
                "牛油果吐司 + 水煮蛋",
                "牛奶煎餅 + 蜂蜜"
            ],
            "午餐": [
                "烤雞胸肉 + 蔬菜沙拉 + 糙米飯",
                "蒸魚 + 地瓜 + 時令蔬菜湯",
                "豆腐蔬菜炒飯 + 湯",
                "瘦牛肉沙拉 + 全麥麵包",
                "火雞肉捲 + 混合沙拉",
                "鮮蝦炒麵 + 青菜",
                "烤鴨腿 + 紫薯 + 蔬菜",
                "素食壽司 + 味噌湯",
                "牛肉燉飯 + 青豆",
                "豆腐炒青菜 + 紫米飯",
                "番茄牛肉燉飯 + 蔬菜",
                "烤雞肉捲 + 混合沙拉",
                "蔬菜炒麵 + 海鮮湯",
                "豆腐海鮮燴飯 + 湯",
                "羊肉炒蔬菜 + 全麥飯",
                "泰式牛肉沙拉 + 藜麥",
                "香煎鯖魚 + 糙米飯 + 青菜",
                "素食披薩 + 混合沙拉",
                "雞肉菠菜義大利麵 + 蔬菜湯",
                "鯛魚定食 + 味噌湯"
            ],
            "晚餐": [
                "蒸魚 + 地瓜 + 時令蔬菜湯",
                "烤雞胸肉 + 蔬菜沙拉 + 糙米飯",
                "蔬菜豆腐鍋 + 藜麥",
                "瘦肉燉菜 + 全麥飯",
                "泰式綠咖哩 + 藜麥",
                "烤鮭魚 + 蔬菜拼盤",
                "素食披薩 + 混合沙拉",
                "牛肉燉蘑菇 + 全麥麵包",
                "烤鴨腿 + 地瓜泥",
                "豆腐煲 + 藜麥飯",
                "番茄牛肉燉飯 + 蔬菜",
                "香煎鯖魚 + 藜麥沙拉",
                "雞肉菠菜義大利麵 + 蔬菜湯",
                "素食咖哩 + 全麥飯",
                "烤羊排 + 地瓜泥 + 青菜",
                "蒸鱈魚 + 蔬菜 + 紫米飯",
                "豆腐蔬菜燴飯 + 藜麥",
                "牛肉炒西蘭花 + 藜麥",
                "燉雞肉 + 藜麥沙拉",
                "蔬菜焗飯 + 混合蔬菜"
            ],
            "加餐": [
                "優格 + 堅果",
                "水果沙拉 + 低脂優格",
                "蔬菜棒配鷹嘴豆泥",
                "全麥餅乾 + 水果",
                "低脂起司 + 蘋果片",
                "胡蘿蔔條 + 低脂酸奶",
                "香蕉奶昔",
                "能量棒",
                "堅果混合",
                "水果優格冰沙",
                "藍莓奶昔",
                "燕麥能量球",
                "蔬菜沙拉 + 鷹嘴豆",
                "小份量低脂冰淇淋",
                "番茄片 + 低脂起司",
                "低糖果凍",
                "椰子水 + 堅果",
                "低脂奶酪 + 水果片",
                "葡萄乾 + 無糖優格",
                "水果乾 + 無糖豆奶"
            ]
        },
        "obese": {
              "早餐": [
                "低脂優格 + 蘋果片 + 水煮蛋",
                "全麥吐司 + 牛油果 + 水煮蛋",
                "蔬菜燕麥粥 + 堅果",
                "水果奶昔 + 全麥餅乾",
                "雞蛋蔬菜煎餅 + 豆漿",
                "藍莓優格杯 + 堅果",
                "牛奶煎餅 + 蜂蜜",
                "水果沙拉 + 燕麥餅",
                "素食漢堡 + 蔬菜汁",
                "綜合堅果 + 水果",
                "菠菜芝士歐姆蛋 + 全麥吐司",
                "鳳梨糙米粥 + 水果",
                "豆腐蔬菜湯 + 全麥饅頭",
                "蜂蜜核桃麥片 + 牛奶",
                "番茄炒蛋 + 全麥吐司",
                "水果優格沙拉 + 燕麥餅乾",
                "香菇豆腐粥 + 水果",
                "玉米片 + 低脂牛奶 + 水果",
                "牛油果吐司 + 水煮蛋",
                "牛奶煎餅 + 蜂蜜"
            ],
            "午餐": [
                "烤雞胸肉 + 蔬菜沙拉 + 糙米飯",
                "蒸魚 + 地瓜 + 時令蔬菜湯",
                "豆腐蔬菜炒飯 + 湯",
                "瘦牛肉沙拉 + 全麥麵包",
                "火雞肉捲 + 混合沙拉",
                "鮮蝦炒麵 + 青菜",
                "烤鴨腿 + 紫薯 + 蔬菜",
                "素食壽司 + 味噌湯",
                "牛肉燉飯 + 青豆",
                "豆腐炒青菜 + 紫米飯",
                "番茄牛肉燉飯 + 蔬菜",
                "烤雞肉捲 + 混合沙拉",
                "蔬菜炒麵 + 海鮮湯",
                "豆腐海鮮燴飯 + 湯",
                "羊肉炒蔬菜 + 全麥飯",
                "泰式牛肉沙拉 + 藜麥",
                "香煎鯖魚 + 糙米飯 + 青菜",
                "素食披薩 + 混合沙拉",
                "雞肉菠菜義大利麵 + 蔬菜湯",
                "鯛魚定食 + 味噌湯"
            ],
            "晚餐": [
                "蒸魚 + 地瓜 + 時令蔬菜湯",
                "烤雞胸肉 + 蔬菜沙拉 + 糙米飯",
                "蔬菜豆腐鍋 + 藜麥",
                "瘦肉燉菜 + 全麥飯",
                "泰式綠咖哩 + 藜麥",
                "烤鮭魚 + 蔬菜拼盤",
                "素食披薩 + 混合沙拉",
                "牛肉燉蘑菇 + 全麥麵包",
                "烤鴨腿 + 地瓜泥",
                "豆腐煲 + 藜麥飯",
                "番茄牛肉燉飯 + 蔬菜",
                "香煎鯖魚 + 藜麥沙拉",
                "雞肉菠菜義大利麵 + 蔬菜湯",
                "素食咖哩 + 全麥飯",
                "烤羊排 + 地瓜泥 + 青菜",
                "蒸鱈魚 + 蔬菜 + 紫米飯",
                "豆腐蔬菜燴飯 + 藜麥",
                "牛肉炒西蘭花 + 藜麥",
                "燉雞肉 + 藜麥沙拉",
                "蔬菜焗飯 + 混合蔬菜"
            ],
            "加餐": [
                "優格 + 堅果",
                "水果沙拉 + 低脂優格",
                "蔬菜棒配鷹嘴豆泥",
                "全麥餅乾 + 水果",
                "低脂起司 + 蘋果片",
                "胡蘿蔔條 + 低脂酸奶",
                "香蕉奶昔",
                "能量棒",
                "堅果混合",
                "水果優格冰沙",
                "藍莓奶昔",
                "燕麥能量球",
                "蔬菜沙拉 + 鷹嘴豆",
                "小份量低脂冰淇淋",
                "番茄片 + 低脂起司",
                "低糖果凍",
                "椰子水 + 堅果",
                "低脂奶酪 + 水果片",
                "葡萄乾 + 無糖優格",
                "水果乾 + 無糖豆奶"
            ]
        }
    
    }

    if bmi < 18.5:
        category = "underweight"
    elif 18.5 <= bmi < 24:
        category = "normal"
    elif 24 <= bmi < 27:
        category = "overweight"
    else:
        category = "obese"
    
    selected_menu = {
        meal: random.choice(options)
        for meal, options in menus[category].items()
    }

    menu = (
        f"🥗 **每日菜單建議（{'體重過輕' if category == 'underweight' else '正常體重' if category == 'normal' else '過重' if category == 'overweight' else '肥胖'}）**\n"
        f"• 早餐：{selected_menu['breakfast']}\n"
        f"• 午餐：{selected_menu['lunch']}\n"
        f"• 晚餐：{selected_menu['dinner']}\n"
        f"• 點心：{selected_menu['snack']}"
    )
    return menu

# 處理飲食指導
def handle_diet_guidance(event, line_bot_api, database):
    user_id = event.source.user_id

    # 從資料庫提取使用者的 BMI 資料
    with get_db_connection(database) as conn:
        c = conn.cursor()
        c.execute("SELECT bmi FROM body_data WHERE user_id = ? ORDER BY time DESC LIMIT 1", (user_id,))
        record = c.fetchone()

    if record:
        bmi = record['bmi']
        daily_menu = recommend_daily_menu(bmi)
        reply_message = (
            f"📊 您的 BMI：{bmi:.2f}\n"
            f"🍽️ 每日菜單建議：\n{daily_menu}"
        )
    else:
        reply_message = "❌ 請先進行體態紀錄。"

    line_bot_api.reply_message(event.reply_token, TextSendMessage(text=reply_message))